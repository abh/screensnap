---
kind: pipeline
type: kubernetes
name: default

environment:
  GOCACHE: /cache/pkg/cache
  GOMODCACHE: /cache/pkg/mod

steps:
  - name: test
    image: golang:1.20.2
    volumes:
      - name: go
        path: /go
      - name: gopkg
        path: /cache
    commands:
      - go test -v
      - go build
      - go mod vendor

  - name: docker
    image: harbor.ntppool.org/ntppool/drone-kaniko:main
    pull: always
    volumes:
      - name: go
        path: /go
      - name: gopkg
        path: /cache
    settings:
      repo: ntppool/screensnap
      registry: harbor.ntppool.org
      auto_tag: true
      tags: SHA7,${DRONE_SOURCE_BRANCH}
      cache: true
      username:
        from_secret: harbor_username
      password:
        from_secret: harbor_password

volumes:
  - name: go
    temp: {}
  - name: gopkg
    claim:
      name: go-pkg

---
kind: signature
hmac: 0963a977c56b047129716976c0e0a4557832fc93238cfaaab65d9687ee848a54

...
